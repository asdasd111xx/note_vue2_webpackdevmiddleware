<template>
  <mobile-container :header-config="headerConfig" :class="$style.container">
    <div slot="content" class="content-wrap">
      <home-slider />
      <home-new />
      <home-content />
      <popup v-if="isShowPop" @close="closePop" :sitePostList="sitePostList" />
      <envelope
        v-if="needShowRedEnvelope"
        @closeEvelope="closeEvelope"
        :redEnvelopeData="redEnvelopeData"
      />
    </div>
  </mobile-container>
</template>

<script>
import { getCookie, setCookie } from "@/lib/cookie";
import { mapGetters, mapActions } from "vuex";
import axios from "axios";
import homeContent from "./components/homeContent";
import homeNew from "@/router/mobile/components/common/home/homeNew";
import homeSlider from "@/router/mobile/components/common/home/homeSlider";
import mcenter from "@/api/mcenter";
import mobileContainer from "../common/mobileContainer";
import popup from "@/router/mobile/components/common/home/popup";

export default {
  components: {
    mobileContainer,
    homeSlider,
    homeNew,
    homeContent,
    popup,
    envelope: () =>
      import(
        /* webpackChunkName: 'pageLoading' */ "@/router/mobile/components/common/home/redEnvelope"
      )
  },
  data() {
    return {
      updateBalance: null,
      isShowPop: false,
      sitePostList: null,
      needShowRedEnvelope: false,
      redEnvelopeData: {}
    };
  },
  computed: {
    ...mapGetters({
      loginStatus: "getLoginStatus",
      post: "getPost",
      showRedEnvelope: "getShowRedEnvelope"
    }),
    headerConfig() {
      return {
        hasLogo: true,
        hasMemInfo: true,
        hasSearchBtn: false,
        onClick: () => {
          this.onClick();
        }
      };
    }
  },
  created() {
    // 先顯示彈跳公告關閉後再顯示一般公告
    // 顯示過公告 localStorage.getItem('is-shown-announcement')
    // 不在提示 localStorage.getItem('do-not-show-home-post')
    if (this.loginStatus) {
      localStorage.setItem("is-shown-announcement", true);
      axios({
        method: "get",
        url: "/api/v1/c/player/popup-announcement"
      }).then(res => {
        if (res.data) {
          if (res.data.ret && res.data.ret.length > 0) {
            // 顯示彈跳公告
            this.sitePostList = res.data.ret;
            this.isShowPop = true;
          } else {
            // 顯示一般公吿
            this.closePop(true);
          }
        }
      });
    }
  },
  watch: {
    isShowPop(val) {
      if (val) {
        document.querySelector("body").style = "overflow: hidden";
      } else {
        document.querySelector("body").style = "";
      }
    },
    showRedEnvelope() {
      // if(this.showRedEnvelope.data.status != -1){
      this.needShowRedEnvelope = true;
      this.redEnvelopeData = this.showRedEnvelope;
      // }

      // console.log(`showRedEnvelope is ${this.showRedEnvelope}`);
    }
  },
  mounted() {
    this.updateBalance = setInterval(() => {
      let cid = getCookie("cid");

      if (!cid) {
        clearInterval(this.updateBalance);
        this.updateBalance = null;
      } else {
        this.actionSetUserBalance();
      }
    }, 30000);
  },
  beforeDestroy() {
    clearInterval(this.updateBalance);
    this.updateBalance = null;
  },
  methods: {
    ...mapActions([
      "actionSetGlobalMessage",
      "actionSetPost",
      "actionSetUserBalance",
      "actionSetUserdata",
      "actionSetShowRedEnvelope"
    ]),
    onClick() {
      this.$router.push("/mobile");
    },
    closePop(isFromSitePost) {
      this.isShowPop = false;
      this.sitePostList = null;

      if (localStorage.getItem("do-not-show-home-post") !== "true") {
        setTimeout(() => {
          this.$nextTick(() => {
            if (isFromSitePost && this.post && this.post.list.length > 0) {
              this.isShowPop = true;
            }
          });
        }, 250);
      }
    },
    closeEvelope() {
      this.needShowRedEnvelope = false;
      this.actionSetGlobalMessage({
        msg: "红包派发中，到帐后即可畅玩游戏"
      });
    }
  }
};
</script>

<style lang="scss" module>
div.container {
  background-color: #fff;
}
</style>
